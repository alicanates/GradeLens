{% extends 'core/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ student.full_name }} - Öğrenci Analizi{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>{{ student.full_name }} - ({{ student.student_number }})</h2>
      <a href="{% url 'student_list' %}" class="btn btn-secondary">
          Öğrenci Listesine Dön
      </a>
  </div>

  <div class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Sınav Kağıdı İşlemleri</h5>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadExamPaperModal">
              <i class="bi bi-upload me-1"></i> Sınav Kağıdı Yükle
          </button>
      </div>

      <div class="btn-group">
          <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#viewExamPaperModal">
              <i class="bi bi-eye me-1"></i> Sınav Kağıdını Görüntüle
          </button>
          <a href="{% url 'download_exam_paper' student.student_number %}" class="btn btn-success">
              <i class="bi bi-download me-1"></i> Sınav Kağıdını İndir
          </a>
      </div>
  </div>

  {% if exam_details %}
      {% for exam in exam_details %}
          <div class="card mb-4">
              <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">
                      {{ exam.course_code_semester }} - {{ exam.course_name }}
                  </h5>
                  <button class="btn btn-info btn-sm"
                          data-bs-toggle="collapse"
                          data-bs-target="#exam{{ forloop.counter }}">
                      Detaylı Analiz
                  </button>
              </div>
              <div class="card-body">
                  <div class="row">
                      <div class="col-md-4">
                          <p><strong>Sınav Türü:</strong> {{ exam.exam_type }}</p>
                      </div>
                      <div class="col-md-4">
                          <p><strong>Sınav Tarihi:</strong> {{ exam.exam_date }}</p>
                      </div>
                      <div class="col-md-4">
                          <p><strong>Toplam Puan:</strong> {{ exam.total_score }}</p>
                      </div>
                  </div>

                  <div class="collapse" id="exam{{ forloop.counter }}">
                      <div class="mt-3">
                          <h6>Soru Bazlı Analiz</h6>
                          <div class="table-responsive">
                              <table class="table table-sm">
                                  <thead>
                                      <tr>
                                          <th>Soru No</th>
                                          <th>Alınan Puan</th>
                                          <th>Maksimum Puan</th>
                                          <th>Başarı Oranı</th>
                                          <th>Grafik</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      {% for ratescores, max_score in exam.success_rates|zip_lists:exam.question_scores|zip_lists:exam.max_scores %}
                                          {% with rate=ratescores.0 score=ratescores.1 %}
                                              <tr>
                                                  <td>Soru {{ forloop.counter }}</td>
                                                  <td>{{ score }}</td>
                                                  <td>{{ max_score }}</td>
                                                  <td>%{{ rate }}</td>
                                                  <td>
                                                      <div class="progress" style="height: 20px;">
                                                          <div class="progress-bar {% if rate >= 70 %}bg-success{% elif rate >= 40 %}bg-warning{% else %}bg-danger{% endif %}"
                                                               role="progressbar"
                                                               style="width: {{ rate }}%"
                                                               aria-valuenow="{{ rate }}"
                                                               aria-valuemin="0"
                                                               aria-valuemax="100">
                                                              {{ rate }}%
                                                          </div>
                                                      </div>
                                                  </td>
                                              </tr>
                                          {% endwith %}
                                      {% endfor %}
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      {% endfor %}
  {% else %}
      <div class="alert alert-info">
          Bu öğrenciye ait sınav kaydı bulunmamaktadır.
      </div>
  {% endif %}
</div>

<!-- Yükleme Modalı -->
<div class="modal fade" id="uploadExamPaperModal" tabindex="-1" aria-labelledby="uploadExamPaperModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="uploadExamPaperModalLabel">Sınav Kağıdı Yükle</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
          </div>
          <form method="post" action="{% url 'upload_exam_paper' student.student_number %}" enctype="multipart/form-data" id="examPaperUploadForm">
              <div class="modal-body">
                  {% csrf_token %}
                  <div class="mb-3">
                      <label for="examPaperFile" class="form-label">PDF Dosyası Seçin</label>
                      <input type="file" class="form-control" id="examPaperFile" name="file" accept=".pdf" required>
                      <div class="form-text">Maksimum dosya boyutu: 5MB</div>
                  </div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                  <button type="submit" class="btn btn-primary">Yükle</button>
              </div>
          </form>
      </div>
  </div>
</div>

<!-- Görüntüleme Modalı -->
<div class="modal fade" id="viewExamPaperModal" tabindex="-1" aria-labelledby="viewExamPaperModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="viewExamPaperModalLabel">Sınav Kağıdı</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
          </div>
          <div class="modal-body p-0">
              <div id="pdfViewer" style="width: 100%; height: 600px;">
                  <canvas id="pdfCanvas"></canvas>
              </div>
          </div>
          <div class="modal-footer">
              <div class="btn-group">
                  <button id="prevPage" class="btn btn-secondary">
                      <i class="bi bi-chevron-left"></i> Önceki
                  </button>
                  <span class="btn btn-light disabled" id="pageInfo">Sayfa: 0 / 0</span>
                  <button id="nextPage" class="btn btn-secondary">
                      Sonraki <i class="bi bi-chevron-right"></i>
                  </button>
              </div>
              <div class="btn-group ms-2">
                  <button id="zoomOut" class="btn btn-secondary">
                      <i class="bi bi-zoom-out"></i>
                  </button>
                  <button id="zoomIn" class="btn btn-secondary">
                      <i class="bi bi-zoom-in"></i>
                  </button>
              </div>
          </div>
      </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const pdfViewerModal = document.getElementById('viewExamPaperModal');
    const canvas = document.getElementById('pdfCanvas');
    const prevButton = document.getElementById('prevPage');
    const nextButton = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    const zoomInButton = document.getElementById('zoomIn');
    const zoomOutButton = document.getElementById('zoomOut');

    let pdfDoc = null;
    let pageNum = 1;
    let scale = 1.5;

    function renderPage(num) {
        pdfDoc.getPage(num).then(function(page) {
            const viewport = page.getViewport({ scale: scale });
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = {
                canvasContext: canvas.getContext('2d'),
                viewport: viewport
            };

            page.render(renderContext);
            pageInfo.textContent = `Sayfa: ${pageNum} / ${pdfDoc.numPages}`;
        });
    }

    pdfViewerModal.addEventListener('show.bs.modal', async function() {
        try {
            // PDF içeriğini API'den al
            const response = await fetch("{% url 'view_exam_paper' student.student_number %}");
            if (!response.ok) {
                throw new Error('PDF alınamadı');
            }

            const data = await response.json();

            // Base64 formatındaki PDF'i binary arraye çevir
            const pdfData = atob(data.pdf_content);
            const pdfArray = new Uint8Array(pdfData.length);
            for (let i = 0; i < pdfData.length; i++) {
                pdfArray[i] = pdfData.charCodeAt(i);
            }

            // PDF'i yükle ve göster
            pdfjsLib.getDocument({data: pdfArray}).promise.then(function(pdf) {
                pdfDoc = pdf;
                renderPage(pageNum);
            }).catch(function(error) {
                console.error('PDF yüklenirken hata:', error);
                alert('PDF dosyası yüklenirken bir hata oluştu.');
            });
        } catch (error) {
            console.error('PDF alınırken hata:', error);
            alert('PDF dosyası alınırken bir hata oluştu.');
        }
    });

    prevButton.addEventListener('click', function() {
        if (pageNum <= 1) return;
        pageNum--;
        renderPage(pageNum);
    });

    nextButton.addEventListener('click', function() {
        if (pageNum >= pdfDoc.numPages) return;
        pageNum++;
        renderPage(pageNum);
    });

    zoomInButton.addEventListener('click', function() {
        scale += 0.2;
        renderPage(pageNum);
    });

    zoomOutButton.addEventListener('click', function() {
        if (scale <= 0.4) return;
        scale -= 0.2;
        renderPage(pageNum);
    });

    pdfViewerModal.addEventListener('hidden.bs.modal', function() {
        pdfDoc = null;
        pageNum = 1;
        scale = 1.5;
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    });
});
</script>
{% endblock %}